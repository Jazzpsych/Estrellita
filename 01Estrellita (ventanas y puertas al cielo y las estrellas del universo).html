<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Para mi Estrellita üåü</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #fce4ec;
            color: #333;
            margin: 0;
            padding: 10px;
        }
        h1 {
            color: #d81b60;
            margin: 10px 0;
        }
        select, button, input {
            padding: 8px;
            margin: 5px;
            font-size: 16px;
        }
        #mensaje {
            font-size: 20px;
            margin-top: 15px;
            font-weight: bold;
            color: #880e4f;
        }
        .imagenes-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 15px;
        }
        .imagen-item {
            margin-bottom: 15px;
        }
        .imagen-item img {
            width: 100%;
            max-width: 300px;
            border-radius: 5px;
        }
        .imagen-emojis {
            margin-top: 5px;
            font-size: 20px;
        }
        .imagen-emojis a {
            text-decoration: none;
            color: #d81b60;
            margin-left: 10px;
        }
        .imagen-emojis a:hover {
            color: #880e4f;
        }
        .mensaje-item {
            text-align: left;
            margin: 8px 0;
            padding: 5px;
            background-color: #f8f8f8;
            border-radius: 5px;
        }
        #loginError {
            color: red;
        }
        #contenido {
            max-width: 600px;
            margin: 0 auto;
        }
        .password-container {
            position: relative;
            display: inline-block;
        }
        #togglePassword {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
        }
        .contador-emociones {
            margin: 15px auto;
            text-align: left;
            max-width: 400px;
            background-color: #f8bbd0;
            padding: 10px;
            border-radius: 10px;
            display: none;
        }
        .contador-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        .contador-label {
            font-weight: bold;
            color: #880e4f;
        }
        .contador-valor {
            font-weight: bold;
            background-color: white;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 30px;
            text-align: center;
        }
        #mensajeInput {
            width: 70%;
            resize: vertical;
            min-height: 40px;
            max-height: 100px;
        }
        .historial-item {
            margin: 5px 0;
            padding: 5px;
            background-color: #f8f8f8;
            border-radius: 5px;
        }
        #admin-info {
            background-color: #e8f5e9;
            border: 1px solid #81c784;
            padding: 10px;
            margin: 10px 0;
            text-align: left;
            border-radius: 5px;
            display: none;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        #chat {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            height: 60vh;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
        }
        .input-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin-top: 5px;
            padding: 0 10px;
            box-sizing: border-box;
        }
        #enviarMensaje {
            margin-left: 5px;
        }

        /* Media Queries para m√≥viles */
        @media (max-width: 600px) {
            body {
                padding: 5px;
            }
            h1 {
                font-size: 24px;
            }
            select, button, input {
                padding: 6px;
                margin: 3px;
                font-size: 14px;
            }
            #mensaje {
                font-size: 18px;
            }
            #chat {
                height: 50vh;
            }
            #mensajeInput {
                width: 65%;
                min-height: 30px;
                font-size: 14px;
            }
            #enviarMensaje {
                padding: 6px 10px;
                font-size: 14px;
            }
            .input-container {
                margin-top: 3px;
            }
            .contador-emociones {
                max-width: 100%;
                padding: 8px;
            }
            #historial-container {
                max-height: 150px;
            }
            .imagen-item {
                margin-bottom: 10px;
            }
            .imagen-item img {
                max-width: 250px;
            }
            .imagen-emojis {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <h1>Para mi Estrellita üåü</h1>

    <div id="loginContainer">
        <h2>Iniciar Sesi√≥n</h2>
        <input type="email" id="email" placeholder="Correo electr√≥nico" required>
        <div class="password-container">
            <input type="password" id="password" placeholder="Contrase√±a" required>
            <button type="button" id="togglePassword">üëÅ</button>
        </div>
        <button id="login">Iniciar sesi√≥n</button>
        <p id="loginError"></p>
    </div>

    <div id="contenido" style="display: none;">
        <button id="logout" style="background-color: red; color: white; padding: 10px; border: none; cursor: pointer;">Cerrar Sesi√≥n</button>

        <!-- Panel de informaci√≥n del administrador -->
        <div id="admin-info">
            <h3>Panel de administrador</h3>
            <p id="usuario-actual-info">Usuario actual: <strong id="usuario-nombre">No detectado</strong></p>
            <p id="admin-status-info">Estado de administrador: <strong id="admin-status">No</strong></p>
        </div>

        <p>¬øC√≥mo te sientes hoy, mi ni√±a?</p>
        <select id="emocion">
            <option value="feliz">Feliz üòä</option>
            <option value="triste">Triste üòî</option>
            <option value="estresada">Estresada üòµ‚Äçüí´</option>
            <option value="cansada">Cansada ü•±</option>
            <option value="extra√±andote">Extra√±√°ndote ü•∫</option>
            <option value="pensandoEnTi">Pensando en ti üí≠‚ù§Ô∏è</option>
            <option value="conGanasDeVerte">Con ganas de verte ü•∞</option>
            <option value="conGanasDePensar">Con ganas de "pensar" üòè</option>
        </select>
        <button onclick="mostrarMensaje()">Ver mensaje</button>
        <p id="mensaje"></p>

        <div id="contador-emociones" class="contador-emociones">
            <h3>Contador de Emociones ‚ù§Ô∏è</h3>
            <div id="contadores-container">
                <!-- Los contadores se cargar√°n din√°micamente aqu√≠ -->
            </div>
        </div>

        <!-- Historial de emociones -->
        <div id="historial-emociones" class="contador-emociones">
            <h3>Historial de Emociones ‚è±Ô∏è</h3>
            <div id="historial-container" style="max-height: 200px; overflow-y: auto;">
                <!-- El historial se cargar√° aqu√≠ -->
            </div>
        </div>

        <div class="imagenes-container">
            <div class="imagen-item">
                <img src="https://i.imgur.com/8jWcK6P.png" alt="Piano con notas musicales">
                <div class="imagen-emojis">
                    <span>‚ù§Ô∏è</span>
                    <a href="https://www.youtube.com/watch?v=Chs2bmqzyUs&pp=ygU8a2lzcyBtZSBvbmNlIGFuZCBraXNzIG1lIHR3aWNlIGFuZCBraXNzIG1lIG9uY2UgYWdhaW4gbHlyaWNz">üéµ‚ù§Ô∏è</a>
                </div>
            </div>
            <div class="imagen-item">
                <img src="https://i.imgur.com/qO3JLoN.jpeg" alt="Estrellita especial">
                <div class="imagen-emojis">
                    <span>‚ù§Ô∏è</span>
                    <a href="https://www.youtube.com/watch?v=H-H8U6As-wg&pp=ygUPc28gdGhpcyBpcyBsb3Zl">üéµ‚ù§Ô∏è</a>
                </div>
            </div>
        </div>

        <h2>Chat con Estrellita üí¨</h2>
        <div class="chat-container">
            <div id="chat"></div>
            <div class="input-container">
                <textarea id="mensajeInput" placeholder="Escribe un mensaje..." rows="2"></textarea>
                <button id="enviarMensaje">Enviar</button>
            </div>
        </div>
    </div>

    <script>
        // Frases para cada emoci√≥n
        const frases = {
            feliz: [
                "Me encanta saber que est√°s feliz, mi ni√±a. Siempre quiero verte as√≠. üå∏",
                "Tu felicidad es mi felicidad, mi amor. Que nunca te falte una sonrisa. üòä",
                "Hoy el sol brilla m√°s porque t√∫ est√°s feliz. ‚òÄÔ∏èüíñ"
            ],
            triste: [
                "Recuerda que, pase lo que pase, siempre estar√© para ti. Te quiero infinito. üíï",
                "Las nubes pasan, pero el cielo sigue ah√≠. Y yo tambi√©n estar√© siempre contigo. üåßÔ∏è‚ù§Ô∏è",
                "Si est√°s triste, piensa en lo mucho que significas para m√≠. üíñ"
            ],
            estresada: [
                "A veces as√≠ es la vida, mi princesita. Respira hondo, cierra los ojos y recuerda que eres capaz de todo. ‚ù§Ô∏è",
                "Descansa un momento, rel√°jate y recuerda que todo pasar√°. üå∏",
                "Eres fuerte, mi amor. M√°s de lo que crees. üí™‚ú®"
            ],
            cansada: [
                "Descansa, mi estrellita. Yo me encargar√© de iluminar tu camino mientras lo haces. ‚ú®",
                "Cada d√≠a es un paso m√°s, pero tambi√©n mereces un respiro. Rel√°jate, mi vida. üíï",
                "Dormir bien es importante, pero so√±ar contigo lo es m√°s. üòòüåô"
            ],
            extra√±andote: [
                "T√∫ dices que me extra√±as... Pero yo te extra√±o m√°s. Y lo sabes. ü•∫‚ù§Ô∏è",
                "La distancia solo hace que te quiera m√°s. üí´",
                "Ojal√° pudiera abrazarte ahora mismo. Pero mientras tanto, aqu√≠ tienes un mensaje con mucho amor. üíñ"
            ],
            pensandoEnTi: [
                "Ahora mismo estaba pensando en ti... Aunque en realidad, siempre lo hago. ü•∞",
                "Eres mi pensamiento favorito del d√≠a. üí≠‚ù§Ô∏è",
                "Si supieras cu√°ntas veces pienso en ti al d√≠a, te asustar√≠as. üòÜüíì"
            ],
            conGanasDeVerte: [
                "Ojal√° pudiera verte ahora mismo. ¬øSabes cu√°nto dar√≠a por eso? Much√≠simo. üíñ",
                "Contando los d√≠as para verte de nuevo... Porque cada segundo sin ti es un siglo. ‚è≥‚ù§Ô∏è",
                "Si pudiera teletransportarme, ya estar√≠a contigo. üí´"
            ],
            conGanasDePensar: [
                "¬øOtra vez con ganas de 'pensar'? üòè Bueno... La verdad es que yo tambi√©n. ‚ù§Ô∏è‚Äçüî•",
                "Pensar contigo siempre es una buena idea. üòâ",
                "Sabes que cuando dices eso, solo me dan m√°s ganas de verte... üòèüî•"
            ]
        };

        function obtenerFraseDiaria(emocion) {
            const hoy = new Date().toISOString().split("T")[0];
            const clave = `frase-${emocion}-${hoy}`;
            let fraseGuardada = localStorage.getItem(clave);

            if (!fraseGuardada) {
                const frasesDisponibles = frases[emocion];
                fraseGuardada = frasesDisponibles[Math.floor(Math.random() * frasesDisponibles.length)];
                localStorage.setItem(clave, fraseGuardada);
            }
            return fraseGuardada;
        }

        function mostrarMensaje() {
            const emocion = document.getElementById("emocion").value;
            const mensaje = obtenerFraseDiaria(emocion);
            document.getElementById("mensaje").innerText = mensaje;
            incrementarContadorEmocion(emocion);
        }

        document.getElementById("password").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                document.getElementById("login").click();
            }
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onChildAdded, get, set, onValue, serverTimestamp, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAcweOs5qS3v4xbzmkYCFLKxVaSWVsly_M",
            authDomain: "estrellita-chl.firebaseapp.com",
            databaseURL: "https://estrellita-chl-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "estrellita-chl",
            storageBucket: "estrellita-chl.firebasestorage.app",
            messagingSenderId: "1006618062076",
            appId: "1:1006618062076:web:8cc3a6bb3ebe800d11fb79",
            measurementId: "G-X2K8ZCR608"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getDatabase(app);

        const USUARIO_ESTRELLITA = "oras5982";
        const USUARIO_ADMIN = "jahaziel.alvarezreyes";

        let inactivityTimer;
        let usuarioActual = "";
        let loginTime = null;

        function cargarEmailJS() {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js';
            script.onload = function() {
                window.emailjs.init('FK-l7zhLUb3b7Ah2X');
            };
            document.head.appendChild(script);
        }
        cargarEmailJS();

        function enviarNotificacionAcceso(usuario) {
            if (window.emailjs) {
                window.emailjs.send('service_mrtsxqh', 'template_xypee8k', {
                    from_name: usuario,
                    message: "Ha iniciado sesi√≥n en la aplicaci√≥n",
                    date: new Date().toLocaleString()
                }).then(function(response) {
                    console.log('Notificaci√≥n de acceso enviada:', response.status, response.text);
                }, function(error) {
                    console.error('Error al enviar notificaci√≥n:', error);
                });
            }
        }

        function inicializarNotificacionesMensajes() {
            onChildAdded(ref(db, "mensajes"), function (snapshot) {
                const data = snapshot.val();
                if (data.usuario === "Estrellita" && usuarioActual !== USUARIO_ADMIN) {
                    enviarCorreo(data.usuario, data.mensaje, data.fecha);
                }
            });
        }

        function inicializarEstadoConexion() {
            const estadoRef = ref(db, "estadoUsuarios/Estrellita");
            if (usuarioActual === USUARIO_ESTRELLITA) {
                set(estadoRef, true);
                onDisconnect(estadoRef).set(false);
                enviarNotificacionAcceso("Estrellita");
            }
            onValue(estadoRef, (snapshot) => {
                const conectado = snapshot.val();
                console.log("Estado de Estrellita:", conectado ? "Conectada" : "Desconectada");
                if (conectado && usuarioActual === USUARIO_ADMIN) {
                    mostrarNotificacionLocal("¬°Estrellita ha iniciado sesi√≥n!");
                }
            });
        }

        function enviarCorreo(usuario, mensaje, fecha) {
            if (window.emailjs) {
                window.emailjs.send('service_mrtsxqh', 'template_xypee8k', {
                    from_name: usuario,
                    message: mensaje,
                    date: fecha
                }).then(function(response) {
                    console.log('Correo enviado:', response.status, response.text);
                }, function(error) {
                    console.error('Error al enviar correo:', error);
                });
            }
        }

        function mostrarNotificacionLocal(mensaje) {
            if (Notification.permission === "granted") {
                new Notification("Estrellita App", { body: mensaje });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification("Estrellita App", { body: mensaje });
                    }
                });
            }
        }

        const listaEmociones = [
            { value: "feliz", label: "Feliz üòä" },
            { value: "triste", label: "Triste üòî" },
            { value: "estresada", label: "Estresada üòµ‚Äçüí´" },
            { value: "cansada", label: "Cansada ü•±" },
            { value: "extra√±andote", label: "Extra√±√°ndote ü•∫" },
            { value: "pensandoEnTi", label: "Pensando en ti üí≠‚ù§Ô∏è" },
            { value: "conGanasDeVerte", label: "Con ganas de verte ü•∞" },
            { value: "conGanasDePensar", label: "Con ganas de 'pensar' üòè" }
        ];

        function obtenerNombreUsuario(email) {
            return email.split('@')[0].toLowerCase();
        }

        function obtenerNombreMostrado(email) {
            const usuario = obtenerNombreUsuario(email);
            return usuario === USUARIO_ESTRELLITA ? "Estrellita" : "Luna";
        }

        function registrarAcceso(usuario) {
            if (usuario === USUARIO_ESTRELLITA) {
                const accessLogRef = ref(db, "accesos");
                push(accessLogRef, {
                    usuario: usuario,
                    timestamp: serverTimestamp(),
                    fecha: new Date().toLocaleString(),
                    inicio: new Date().getTime()
                });
                loginTime = new Date().getTime();
            }
        }

        function registrarTiempoSesion(usuario) {
            if (usuario === USUARIO_ESTRELLITA && loginTime !== null) {
                const sessionEndTime = new Date().getTime();
                const sessionDuration = (sessionEndTime - loginTime) / 1000 / 60;
                const sessionLogRef = ref(db, "tiempoSesiones");
                push(sessionLogRef, {
                    usuario: usuario,
                    timestamp: serverTimestamp(),
                    fecha: new Date().toLocaleString(),
                    duracionMinutos: sessionDuration.toFixed(2),
                    inicio: new Date(loginTime).toLocaleString(),
                    fin: new Date().toLocaleString()
                });
                loginTime = null;
            }
        }

        function inicializarContadoresEmociones() {
            const contadoresRef = ref(db, "contadores");
            get(contadoresRef).then((snapshot) => {
                if (!snapshot.exists()) {
                    const contadoresIniciales = {};
                    listaEmociones.forEach(emocion => {
                        contadoresIniciales[emocion.value] = 0;
                    });
                    set(contadoresRef, contadoresIniciales);
                }
            }).catch(error => {
                console.error("Error al inicializar contadores:", error);
            });

            const usuario = obtenerNombreUsuario(auth.currentUser.email);
            usuarioActual = usuario;
            actualizarInfoAdmin(usuario);

            const contadorElement = document.getElementById("contador-emociones");
            const historialElement = document.getElementById("historial-emociones");

            if (usuario === USUARIO_ADMIN) {
                console.log("¬°Usuario administrador detectado!", usuario);
                contadorElement.style.display = "block";
                historialElement.style.display = "block";
                onValue(contadoresRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const contadores = snapshot.val();
                        actualizarUIContadores(contadores);
                    }
                });
                inicializarHistorialEmociones();
            } else {
                console.log("Usuario no administrador:", usuario);
                contadorElement.style.display = "none";
                historialElement.style.display = "none";
            }
        }

        function actualizarInfoAdmin(usuario) {
            const adminInfoPanel = document.getElementById("admin-info");
            const usuarioNombre = document.getElementById("usuario-nombre");
            const adminStatus = document.getElementById("admin-status");

            if (usuario === USUARIO_ADMIN) {
                adminInfoPanel.style.display = "block";
                usuarioNombre.textContent = usuario;
                adminStatus.textContent = "S√≠";
                adminStatus.style.color = "green";
            } else {
                adminInfoPanel.style.display = "none";
            }
        }

        function actualizarUIContadores(contadores) {
            const contenedor = document.getElementById("contadores-container");
            contenedor.innerHTML = "";
            listaEmociones.forEach(emocion => {
                const contador = contadores[emocion.value] || 0;
                const div = document.createElement("div");
                div.className = "contador-item";
                div.innerHTML = `
                    <span class="contador-label">${emocion.label}:</span>
                    <span class="contador-valor">${contador}</span>
                `;
                contenedor.appendChild(div);
            });
        }

        window.incrementarContadorEmocion = function(emocion) {
            if (usuarioActual === USUARIO_ESTRELLITA) {
                const contadorRef = ref(db, `contadores/${emocion}`);
                get(contadorRef).then((snapshot) => {
                    const valorActual = snapshot.exists() ? snapshot.val() : 0;
                    set(contadorRef, valorActual + 1);
                }).catch(error => {
                    console.error("Error al incrementar contador:", error);
                });

                const historialEmocionesRef = ref(db, "historialEmociones");
                push(historialEmocionesRef, {
                    emocion: emocion,
                    usuario: usuarioActual,
                    timestamp: serverTimestamp(),
                    fecha: new Date().toLocaleString()
                }).catch(error => {
                    console.error("Error al registrar historial:", error);
                });
            }
        };

        function inicializarHistorialEmociones() {
            console.log("Inicializando historial de emociones para administrador");
            const historialRef = ref(db, "historialEmociones");
            onValue(historialRef, (snapshot) => {
                if (snapshot.exists()) {
                    actualizarUIHistorial(snapshot.val());
                }
            });
        }

        function actualizarUIHistorial(historial) {
            const contenedor = document.getElementById("historial-container");
            contenedor.innerHTML = "";
            const historialArray = Object.entries(historial).map(([key, value]) => ({
                id: key,
                ...value
            }));
            historialArray.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            historialArray.slice(0, 100).forEach(evento => {
                const nombreEmocion = listaEmociones.find(e => e.value === evento.emocion)?.label || evento.emocion;
                const div = document.createElement("div");
                div.className = "historial-item";
                div.innerHTML = `
                    <span>${nombreEmocion}</span>
                    <span style="float: right; font-style: italic; font-size: 0.9em;">${evento.fecha}</span>
                `;
                contenedor.appendChild(div);
            });
        }

        document.getElementById("togglePassword").addEventListener("click", function () {
            const passwordInput = document.getElementById("password");
            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                this.innerText = "üôà";
            } else {
                passwordInput.type = "password";
                this.innerText = "üëÅ";
            }
        });

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                registrarTiempoSesion(usuarioActual);
                signOut(auth).then(() => {
                    document.getElementById("contenido").style.display = "none";
                    document.getElementById("loginContainer").style.display = "block";
                    alert("Sesi√≥n cerrada por inactividad");
                });
            }, 5 * 60 * 1000);
        }

        document.getElementById("login").addEventListener("click", function () {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const loginError = document.getElementById("loginError");

            loginError.textContent = "";

            signInWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                document.getElementById("loginContainer").style.display = "none";
                document.getElementById("contenido").style.display = "block";
                resetInactivityTimer();
                usuarioActual = obtenerNombreUsuario(userCredential.user.email);
                console.log("Inicio de sesi√≥n exitoso. Usuario:", usuarioActual);
                registrarAcceso(usuarioActual);
                inicializarContadoresEmociones();
            })
            .catch((error) => {
                console.error("Error al iniciar sesi√≥n:", error);
                switch(error.code) {
                    case 'auth/invalid-email': loginError.textContent = "El correo electr√≥nico no es v√°lido."; break;
                    case 'auth/user-not-found': loginError.textContent = "No se encontr√≥ un usuario con este correo."; break;
                    case 'auth/wrong-password': loginError.textContent = "La contrase√±a es incorrecta."; break;
                    case 'auth/too-many-requests': loginError.textContent = "Demasiados intentos. Intenta m√°s tarde."; break;
                    default: loginError.textContent = "Error al iniciar sesi√≥n: " + error.message;
                }
            });
        });

        document.getElementById("email").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                document.getElementById("password").focus();
            }
        });

        document.getElementById("logout").addEventListener("click", function () {
            registrarTiempoSesion(usuarioActual);
            signOut(auth).then(() => {
                document.getElementById("contenido").style.display = "none";
                document.getElementById("loginContainer").style.display = "block";
                usuarioActual = "";
            }).catch((error) => {
                console.error("Error al cerrar sesi√≥n:", error);
                alert("Error al cerrar sesi√≥n: " + error.message);
            });
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById("loginContainer").style.display = "none";
                document.getElementById("contenido").style.display = "block";
                resetInactivityTimer();
                usuarioActual = obtenerNombreUsuario(user.email);
                console.log("Usuario detectado en cambio de estado:", usuarioActual);
                registrarAcceso(usuarioActual);
                inicializarContadoresEmociones();
            } else {
                document.getElementById("loginContainer").style.display = "block";
                document.getElementById("contenido").style.display = "none";
                usuarioActual = "";
                loginTime = null;
            }
        });

        document.addEventListener("mousemove", resetInactivityTimer);
        document.addEventListener("keydown", resetInactivityTimer);

        document.getElementById("mensajeInput").addEventListener("keydown", function(event) {
            // Enter agrega salto de l√≠nea
        });

        let mensajesMostrados = new Set();

        function mostrarMensaje(data) {
            if (data.key && mensajesMostrados.has(data.key)) return;

            const chat = document.getElementById("chat");
            const mensajeElemento = document.createElement("div");
            mensajeElemento.classList.add("mensaje-item");

            if (data.key) {
                mensajesMostrados.add(data.key);
                mensajeElemento.setAttribute("data-id", data.key);
            }

            const nombreMostrado = sanitizarTexto(data.usuario || "Usuario");
            const mensajeSanitizado = sanitizarTexto(data.mensaje);
            const mensajeFormateado = mensajeSanitizado.replace(/\n/g, '<br>');
            mensajeElemento.innerHTML = `<p><strong>${nombreMostrado}:</strong> ${mensajeFormateado}</p>`;
            chat.appendChild(mensajeElemento);
            chat.scrollTop = chat.scrollHeight;
        }

        function cargarMensajesIniciales() {
            const mensajesRef = ref(db, "mensajes");
            mensajesMostrados.clear();
            const chat = document.getElementById("chat");
            chat.innerHTML = "";

            get(mensajesRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const mensajes = [];
                    snapshot.forEach((childSnapshot) => {
                        mensajes.push({
                            key: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });

                    mensajes.sort((a, b) => {
                        if (a.timestamp && b.timestamp) return a.timestamp - b.timestamp;
                        return new Date(a.fecha) - new Date(b.fecha);
                    });

                    mensajes.forEach(mensaje => mostrarMensaje(mensaje));
                }
                window.cargaInicialCompletada = true;
            }).catch(error => {
                console.error("Error al cargar mensajes:", error);
                window.cargaInicialCompletada = true;
            });
        }

        function sanitizarTexto(texto) {
            const div = document.createElement('div');
            div.textContent = texto;
            return div.innerHTML;
        }

        function inicializarReceptorMensajes() {
            const mensajesRef = ref(db, "mensajes");
            window.cargaInicialCompletada = false;
            cargarMensajesIniciales();

            onChildAdded(mensajesRef, function (snapshot) {
                if (window.cargaInicialCompletada) {
                    const data = snapshot.val();
                    mostrarMensaje({
                        key: snapshot.key,
                        ...data
                    });
                }
            });
        }

        document.getElementById("enviarMensaje").addEventListener("click", function () {
            const user = auth.currentUser;
            if (!user) return;

            const mensajesRef = ref(db, "mensajes");
            const mensaje = document.getElementById("mensajeInput").value.trim();

            if (mensaje) {
                const nuevoMensaje = {
                    emailCompleto: user.email,
                    usuario: obtenerNombreMostrado(user.email),
                    mensaje: mensaje,
                    fecha: new Date().toLocaleString(),
                    timestamp: new Date().getTime()
                };

                document.getElementById("mensajeInput").value = "";
                const newRef = push(mensajesRef);
                const messageId = newRef.key;

                mostrarMensaje({
                    key: messageId,
                    ...nuevoMensaje
                });

                set(newRef, nuevoMensaje).catch((error) => {
                    console.error("Error al enviar mensaje:", error);
                });

                resetInactivityTimer();
            }
        });

        window.addEventListener('beforeunload', function() {
            registrarTiempoSesion(usuarioActual);
        });

        document.addEventListener('DOMContentLoaded', function() {
            mensajesMostrados = new Set();
            inicializarEstadoConexion();
            inicializarNotificacionesMensajes();
            inicializarReceptorMensajes();
        });
    </script>
</body>
</html>
